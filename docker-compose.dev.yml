version: '3.8'

# Development docker-compose with hot reload
# Usage: docker-compose -f docker-compose.dev.yml up

services:
  # PostgreSQL Database
  db:
    image: postgres:16-alpine
    container_name: meetify-db-dev
    environment:
      POSTGRES_DB: meetify
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
    networks:
      - meetify-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Spring Boot Backend (with volume mount for hot reload via Spring DevTools)
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder  # Use builder stage for development
    container_name: meetify-backend-dev
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/meetify
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_DEVTOOLS_RESTART_ENABLED=true
    ports:
      - "8080:8080"
    volumes:
      # Mount source for hot reload
      - ./src:/app/src
      - ./build.gradle:/app/build.gradle
      - gradle_cache:/root/.gradle
    depends_on:
      db:
        condition: service_healthy
    networks:
      - meetify-network
    command: ["./gradlew", "bootRun", "--no-daemon"]

  # Next.js Frontend (with volume mount for hot reload)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: meetify-frontend-dev
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      - NEXT_PUBLIC_WS_URL=ws://localhost:8080/ws
    ports:
      - "3000:3000"
    volumes:
      # Mount source for hot reload
      - ./frontend/src:/app/src
      - ./frontend/app:/app/app
      - ./frontend/public:/app/public
      - ./frontend/next.config.ts:/app/next.config.ts
      - ./frontend/tailwind.config.ts:/app/tailwind.config.ts
      - ./frontend/postcss.config.mjs:/app/postcss.config.mjs
      - ./frontend/tsconfig.json:/app/tsconfig.json
      # Prevent node_modules from being overwritten
      - /app/node_modules
      - /app/.next
    depends_on:
      - backend
    networks:
      - meetify-network

networks:
  meetify-network:
    driver: bridge

volumes:
  postgres_data_dev:
  gradle_cache:
